## PHÂN TÍCH ExWAS đề kháng insulin 

### Cài đặt devtools / BiocManager
```{r, message = FALSE}
if (!requireNamespace("devtools", quietly = TRUE)) 
  install.packages("devtools")
if (!requireNamespace("BiocManager", quietly=TRUE))
  install.packages("BiocManager")
```

### Cài đặt rexposome dependencies
```{r message = FALSE}
packages = c('Biobase', 'mice', 'MultiDataSet', 'lsr', 'FactoMineR',
	'stringr', 'circlize', 'corrplot', 'ggplot2', 'reshape2', 'pryr',
	'scales', 'imputeLCMD', 'scatterplot3d', 'glmnet', 'gridExtra',
	'grid', 'Hmisc', 'gplots', 'gtools', 'S4Vectors', 'MASS'
)
for( pkg in packages ) {
  if( !pkg %in% rownames( installed.packages() ) ) {
    message( "Installing ", pkg )
    BiocManager::install( pkg )
  }
}
```

### cài đặt rexposome
```{r, message = FALSE}
if (!requireNamespace("rexposome", quietly = TRUE)) {
  message("rexposome chưa được cài, tiến hành cài đặt...")
  devtools::install_github("isglobal-brge/rexposome")
} else {
  message("rexposome đã được cài đặt.")
}
```

### Nạp vào những gói cần thiết 
**Các gói cơ bản**
```{r, message = FALSE}
library(tidyverse)   # xử lý, trực quan hóa dữ liệu
library(readxl)      # đọc file Excel (.xlsx)
library(writexl)     # một package khác để xuất file excel
library(psych)       # thống kê mô tả, kiểm định tâm lý
library(car)         # hồi quy, kiểm định mở rộng
library(mice)        # bù dữ liệu thiếu
library(naniar)      # kiểm tra & trực quan hóa dữ liệu thiếu
library(xtable)      # Chuyển bảng dữ liệu thành bảng LaTeX hoặc HTML (phục vụ xuất báo cáo)
library(gridExtra)   # Sắp xếp và kết hợp nhiều biểu đồ ggplot2 trên cùng một trang
library(Cairo)       # Xuất đồ họa chất lượng cao (PDF, PNG, SVG) với chống răng cưa và hỗ trợ in ấn
```
**Các gói cần cho phân tích ExWAS**
```{r, message = FALSE}
library(rexposome)      # Phân tích exposome: xử lý, mô tả và kiểm định liên quan exposome-kết cục
library(MASS)           # Hỗ trợ mô hình thống kê và phép biến đổi dữ liệu (ví dụ: Box-Cox)
library(MultiDataSet)   # Quản lý và tích hợp nhiều bộ dữ liệu omic hoặc exposome trong một đối tượng
library(corrplot)
```

### Thiết lập đường dẫn 
```{r}
path <- "../../data"
expof <- file.path(path, "exposome_data/exposures.csv")
descf <- file.path(path, "exposome_data/description.csv")
phenf <- file.path(path, "exposome_data/phenotypes.csv")
```

### Tạo ExposomeSet object
```{r}
inre_exp<-readExposome(
  exposures=expof,
  description=descf,
  phenotype=phenf,
  sep= ",",
  description.famCol="family",
  description.expCol="exposure",
  exposures.samCol="sub_id",
  phenotype.samCol="sub_id"
)
dim(inre_exp) # (237: 34) + 5
```

### Khám phá cấu trúc của ExposomeSet object
```{r}
# truy cập tên các đối tượng quan sát
head(sampleNames(inre_exp))
# truy cập vào các biến số phơi nhiễm
exposureNames(inre_exp)
# truy cập vào tên family trong description
familyNames(inre_exp)
# truy cập vào confounder và outcome 
phenotypeNames(inre_exp)
# truy cập vào toàn bộ file descf
fData(inre_exp)
# truy cập vào bảng dữ liệu phenotypes
head(pData(inre_exp), n = 3)
```

### Kiểm tra missing data
```{r}
tableMissings(inre_exp, set = "exposures", output = "n")
tableMissings(inre_exp, set = "phenotypes", output = "n")
plotMissings(inre_exp, set = "exposures")
```

### Kiểm định phân phối chuẩn 
```{r}
nm <- normalityTest(inre_exp)
table(nm$normality)
nm$exposure[!nm$normality]
```
Có 3 biến exposures phân phối chuẩn, còn lại không phân phối chuẩn

### Trực quan hóa dữ liệu exposures 
```{r}
# vẽ box-plot cho tất cả các exposures theo family 
plotFamily(inre_exp, family = "all")
# vẽ box-plot các exposure theo nhóm biến confounder
plotFamily(inre_exp, family = "Fat", group = "sex", group2 = "sex")
```

### Just for fun - thử vẽ biểu đồ sau khi đã chuẩn hóa dữ liệu
```{r}
exp_std <- standardize(inre_exp, method = "normal")
plotFamily(exp_std, family = "all")
```
**Câu hỏi**

- Theo doc, hàm standardize chỉ áp dụng lên các exposures
- Vậy các biến confounder thì có cần standardize không, và làm như thế nào
- Làm thế nào để biểu đồ trên đẹp hơn

### Normalization dữ liệu
```{r}
expo_best_trans <- function(var) {
  var[var == 0] <- 0.00001 #to avoid problems with log(0)
  bc <- boxcox(var ~ 1, plotit = FALSE)
  trans <- bc$x[which.max(bc$y)]
  if (trans < (-1.5)) {
    x <- 1/(var^2)
  } else if (trans < (-0.75) & trans > (-1.5)) { 
    x <- 1/(var)
  } else if (trans < (-0.25) & trans > (-0.75)) {
    x <- 1/(sqrt(var))
  } else if (trans < (0.25) & trans > (-0.25)) {
    x <- log(var)
  } else if (trans < (0.75) & trans > (0.25)) {
    x <- sqrt(var)
  } else if (trans < (1.5) & trans > (0.75)) {
    x <- var
  } else {
    x <- var^2
  }
  return(x)
}

inre_exp_t <- trans(inre_exp, fun=expo_best_trans, by.exposure=TRUE)
# inre_exp_t <- trans(inre_exp, fun=log, by.exposure=TRUE)

```
**Câu hỏi**

- Các biến confounder có cần normalize không và tại sao
- Làm sao để thực hiện được điều này

### Standardization dữ liệu
```{r}
inre_exp_s <- standardize(inre_exp, method="normal")
inre_exp_s
```

### Standardization dữ liệu sau khi đã normalization 
```{r}
inre_exp_t_s <- standardize(inre_exp_t, method="normal")
inre_exp_t_s
```
**Câu hỏi**

- Tại sao dùng phương pháp "normal"mà không dùng Spearman-based scaling như trong bài báo
- Khi nào thì nên chọn cái nào

### Just for fun - thử vẽ biểu đồ sau khi đã chuẩn hóa và bình thường hóa
```{r}
# Lấy dữ liệu ra
df <- expos(inre_exp_s)[1:237, 1:34]
df_long <- reshape2::melt(df, variable.name = "Exposure", value.name = "Measure")

# Thêm cột Family (nếu có description file)
desc <- fData(inre_exp_s)
df_long$Family <- desc$Family[match(df_long$Exposure, rownames(desc))]

# Vẽ lại
ggplot(df_long, aes(x = Exposure, y = Measure, fill = Family)) +
  geom_boxplot(outlier.size = 1, alpha = 0.7) +
  facet_wrap(~ Family, scales = "free_x", ncol = 3) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 9),
    strip.text = element_text(face = "bold", size = 11),
    panel.spacing = unit(1, "lines")
  ) +
  labs(x = NULL, y = "Standardized Measure", title = "Exposure Distributions by Family")
```

- Chú ý cách trích xuất dữ liệu từ ExposomeSet Obj
- df <- expos(inre_exp_s)[1:237, 1:34]
- Bất kỳ hình thức ExposomeSet Obj nào cũng có thể đưa vào expos() để trích xuất thành dữ liệu dạng bảng


### Exploring Exposure Correlations
```{r}
inre_exp_c <- correlation(inre_exp, method.cor = "pearson")
# tạo ra ma trận các hệ số tương quan >= 0.9
cor_matrix <- extract(inre_exp_c)
mask <- abs(cor_matrix) >= 0.5
cor_matrix[!mask] <- 0
# print(cor_matrix[1:10, 1:10])
```

- The correlation between exposures can be computed from original exposure data (e.g
object inma_exp), the transformed data inma_exp_t or from a single imputed data-set.
- The correlation
 method takes into account the nature of each pair of exposures: continuous vs. continuous uses cor function from R base, categorical vs. categorical uses cramerV function from lsr R package and categorical vs. continuous exposures correlation is calculated as the square root of the adjusted r-square obtained from fitting a lineal model with the categorical exposures as dependent variable and the continuous exposure as independent variable. 

### Vẽ biểu đồ tương quan giữa các biến số exposures
```{r}
plotCorrelation(inre_exp_c, type = "circos")
# corrplot(cor_matrix, method="square")
```

```{r}
# Tạo bản sao object gốc
inre_exp_c_filtered <- inre_exp_c

# Lấy ma trận tương quan
cor_mat <- assayDataElement(inre_exp_c_filtered, "corr")

# Chỉ giữ các giá trị |r| >= 0.9
cor_mat[abs(cor_mat) < 0.9] <- 0  # hoặc NA nếu muốn bỏ hẳn các cạnh

# Gán lại vào object
assayDataElement(inre_exp_c_filtered, "corr") <- cor_mat

# Vẽ biểu đồ circos với các kết nối >=0.9
plotCorrelation(
  inre_exp_c_filtered, 
  type = "circos", 
)

```

- Chú ý cách trích xuất corr matrix từ inre_exp_c object bằng assayDataElement
- Các điểm dữ liệu < 0.9 quy bằng 0

### Exposome PCA
```{r}
exp_pca <- pca(inre_exp_t_s, pca = TRUE)
slotNames(exp_pca)
loadings_matrix <- exp_pca@pca$var$coord
```

### Trực quan hóa PCA
```{r, warning = FALSE}
plotPCA(exp_pca, set = "all")
```

```{r}
plotPCA(exp_pca, set = "exposures", show.exposures = TRUE) +
 ggtitle("Insulin resistance - PCA- Exposures Space") + 
  ggplot2::theme(legend.position = "bottom")
```

```{r}
plotPCA(exp_pca, set = "samples", show.exposures = TRUE, show.samples = TRUE, phenotype = "insulin_re") +
 ggtitle("Insulin resistance - PCA- Exposures Space") + 
  ggplot2::theme(legend.position = "bottom")
```

```{r}
plotEXP(exp_pca)
```

```{r}
plotPHE(exp_pca)
```


### Exposome Clustering
```{r}
hclust_data <- function(data, ...) {
  hclust(d = dist(x = data), ...)  
}

hclust_k5 <- function(result) {
  cutree(result, k = 5)  
}

inre_l <- clustering(inre_exp_s, method = hclust_data, cmethod = hclust_k5)

plotClassification(inre_l)
 
```

### ExWAS analysis (un-adjusted model)
```{r}
exwas_unadjusted <- exwas(
  inre_exp_t_s, # cần xác định lại dữ liệu đưa vào có cần normalization không
  formula = insulin_re ~ 1, 
  family = "binomial"
)

exwas_unadjusted_result <- as.data.frame(exwas_unadjusted@comparison)
```

```{r}
plotExwas(exwas_unadjusted, show.effective = TRUE) +
 theme(legend.position = "right")
```

### ExWAS analysis (adjusted model)
```{r}
# model adjusted theo sex + age + zbmi ( calories cần xem xét lại vì có biến calories tương tự trong exposures)

exwas_adjusted <- exwas(
  inre_exp_t_s, # cần xác định lại dữ liệu đưa vào có cần normalization không
  formula = insulin_re ~ sex + age + zbmi,
  family = "binomial"
)

exwas_adjusted_result <- as.data.frame(ex_inre@comparison)
```

```{r}
plotExwas(exwas_adjusted, show.effective = TRUE) +
 theme(legend.position = "right")
```

```{r}
plotVolcano(exwas_adjusted, p.value =-log10(0.0001), lab, show.effect = TRUE)
```

```{r}
plotEffect(exwas_adjusted)
```

### Sensitivity analysis: stratified models
```{r}
strat_var <- "sex"
formula <- insulin_re ~ age + zbmi

strat_obj <- lapply(levels(as.factor(pData(inre_exp_t_s)[[strat_var]])), function(i) {
  mask <- pData(inre_exp_t_s)[[strat_var]] == i
  data_i <- inre_exp_t_s[ , mask]
  exwas_i <- exwas(
    data_i, 
    family = "binomial", 
    formula = formula
  )
  exwas_i@formula <- update.formula(exwas_i@formula, as.formula(paste0(
    ". ~ .", 
    "strata(",
    strat_var, 
    "_",
    gsub("[[:space:]]|-|+|(|)", "", i),
    ")"
  )))
  return(exwas_i)
})

do.call(plotExwas, strat_obj)

```











